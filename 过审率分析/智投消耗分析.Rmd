---
title: '智投消耗分析'
author:  ''
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

注意在`campaign`中`day_budget=0`的是预算不限的情况

```sql
-- campaign.budget_type=1 不限预算
-- campaign.budget_type=2 统一预算
-- campaign.budget_type=3 每日预算

select budget_type, count(day_budget) as '数量'
from makepolo.campaign
group by 1
order by 1
```

| budget\_type | 数量 |
| :--- | :--- |
| 1 | 566355 |
| 2 | 51771 |
| 3 | 2720 |



```sql
select budget_type as '预算类型',
       count(*)
from makepolo.ad_unit
group by 1
order by 1
```

| 预算类型 | count(*) |
| :--- | :--- |
| 1 | 5741691 |
| 2 | 294393 |
| 3 | 27304 |



```sql
select a.date as date
      , a.company_id
      , cost
      , day_budget
      , cost / day_budget as cost_rate
     -- , sum(day_budget) as day_budget
     -- , sum(cost) as cost
from (
select date
     , company_id
     , sum(cost) as cost
from  makepolo.creative_report
where create_channel =1
group by 1, 2
) a left join (
select date_format(create_time,'%Y-%m-%d') as date
     ,company_id
     ,sum(day_budget) as day_budget
from makepolo.campaign
where day_budget>0
group by 1,2
-- order by 1 desc
)budget on budget.company_id = a.company_id and budget.date = a.date
where day_budget>0 -- 筛选预算>0的
```

从以上代码发现，消耗远大于预算。下面不分日期查询，而是筛选一段较长的时间。

```sql
select a.company_id
      , cost
      , day_budget
      , cost / day_budget as cost_rate
from (
select company_id
     , sum(cost) as cost
from  makepolo.creative_report
where create_channel =1   and date>='2020-09-07'
  and date<='2020-10-13'
group by 1
) a left join (
select company_id
     ,sum(day_budget) as day_budget
from makepolo.campaign
where day_budget>0
  and create_time>='2020-09-07 00:00:00'
  and create_time<='2020-10-13 23:59:59'
group by 1
-- order by 1 desc
)budget on budget.company_id = a.company_id
where day_budget>0
```

消耗仍然远大于预算。原因是有些公司可能不限预算。

下面使用`vendor_campaign_id`来进行聚合。

```sql
select a.vendor_campaign_id
      , cost
      , day_budget
      , cost / day_budget as cost_rate
from (
select vendor_campaign_id
     , sum(cost) as cost
from  makepolo.creative_report
where create_channel =1 and date>='2020-10-13'
  and date<='2020-10-13'
group by 1
) a left join (
select vendor_campaign_id
     ,sum(day_budget) as day_budget
from makepolo.campaign
where day_budget>0
  and create_time>='2020-10-13 00:00:00'
  and create_time<='2020-10-13 23:59:59'
group by 1
-- order by 1 desc
)budget on budget.vendor_campaign_id = a.vendor_campaign_id
where day_budget>0
```

发现消耗远小于预算。

按`ad_unit_id`进行计算：(2020/10/20有可能正确的分析)

```sql
select a.ad_unit_id
      , a.date as dat
     , budget_type
      , cost
      , day_budget
      , cost / day_budget as '消耗/预算'
from (
select date
     , ad_unit_id
     , sum(cost) as cost
from  makepolo.creative_report
where create_channel =1 and date='2020-10-19'
group by 1,2
) a left join (
select id as ad_unit_id
     , day_budget
     , budget_type
from makepolo.ad_unit
where day_budget>0 and day_budget<4000000000
 --  and create_time>='2020-10-07 00:00:00'
 --  and create_time<='2020-10-07 23:59:59'
  and budget_type=3 -- 删除不限预算的情况
-- group by 1
-- order by 1 desc
)budget on a.ad_unit_id = budget.ad_unit_id
where budget_type =3
order by 6 desc
```

```sql
select a.campaign_id
      , cost
      , day_budget
      , cost / day_budget as cost_rate
from (
select campaign_id
     , sum(cost) as cost
from  makepolo.creative_report
where create_channel =1 and date>='2020-10-13'
  and date<='2020-10-13'
group by 1
) a left join (
select id as campaign_id
     ,sum(day_budget) as day_budget
from makepolo.campaign
where day_budget>0
  and create_time>='2020-10-13 00:00:00'
  and create_time<='2020-10-13 23:59:59'
group by 1
-- order by 1 desc
)budget on budget.campaign_id = a.campaign_id
where day_budget>0
order by 4 desc
```

对比是否使用api的消耗占比的不同

```sql
select create_channel
       , sum(cost) / sum(day_budget) as '消耗/预算'
from (
select a.ad_unit_id
      , a.date as dat
     , budget_type
      , cost
      , day_budget
      , cost / day_budget as '消耗/预算'
      , create_channel
from (
select date
     , ad_unit_id
     , create_channel
     , sum(cost) as cost
from  makepolo.creative_report
where date='2020-10-19'
group by 1,2,3
) a left join (
select id as ad_unit_id
     , day_budget
     , budget_type
from makepolo.ad_unit
where day_budget>0 and day_budget<4000000000
  and budget_type=3 -- 删除不限预算的情况
)budget on a.ad_unit_id = budget.ad_unit_id
where budget_type =3
    ) b group by 1
```










